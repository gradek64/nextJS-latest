name: SonarQube Quality Gate
on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
    paths-ignore:
      - 'README.md'
permissions: write-all

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  code-analysis:
    name: Code Analysis
    runs-on: 
      - self-hosted
      - build
    timeout-minutes: 20
    env:
      GITHUB_PACKAGES_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: sainsburys-tech/sonarqube-typescript@v1
        with:
          sonar-host-url: ${{ vars.SONAR_ORG_HOST_URL }}
          sonar-token: ${{ secrets.SONAR_ORG_TOKEN }}
          project-key: 'sainsburys-tech_gm-basket-wishlist-ui_8ed6ab47-2f44-4234-bece-e72497e4951b'
          node-version-file: '.nvmrc'
          test-command: npm run # update with command after setting up jest and RTL
          packages-token: ${{ secrets.READ_PACKAGES_TOKEN }}
  code-checks:
    name: Code Checks
    runs-on:
      - self-hosted
      - build
    env:
      GITHUB_PACKAGES_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run Linting
        run: npm run lint
      
      - name: Run BundleWatch
        run: npm run bundlewatch
  build:
    uses: ./.github/workflows/reusable-build.yaml
    with:
      bosun-config: ./bosun.yaml
      image-tags: $ECR/$BOSUN_PRODUCT/$BOSUN_APP:$SHORT_SHA-dev
    secrets: inherit

  deploy-feature-branch:
    needs: [build, code-checks]
    uses: ./.github/workflows/reusable-deploy.yaml
    with:
      bosun-config: ./bosun.yaml
      environment: dev
      job-name: 'deploy-feature-branch'
      tags: ${{ needs.build.outputs.tags }}
    secrets: inherit